<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stoloto Assistant</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">Stoloto Assistant</div>
            <ul class="navbar-nav">
                <li><a href="/dashboard" class="active">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/lotteries">–í—Å–µ –ª–æ—Ç–µ—Ä–µ–∏</a></li>
                <li><a href="/chat">–ß–∞—Ç</a></li>
                <li><a href="#" onclick="logout()">–í—ã—Ö–æ–¥</a></li>
            </ul>
        </div>
    </nav>

    <main style="padding-top: 80px;">
        <section class="py-lg">
            <div class="container">
                <div class="mb-xl">
                    <h1 id="user-greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
                    <p style="color: var(--color-text-muted);">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤—ã–±–æ—Ä—É –ª–æ—Ç–µ—Ä–µ–π</p>
                </div><!-- Chat CTA -->
                <div class="flex-center mb-xl">
                    <a href="/chat" class="btn btn-primary btn-large">
                        üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º
                    </a>
                </div>
            </div>
        </section>

        <!-- Statistics Section -->
        <section class="py-lg" style="background: var(--color-bg-secondary);">
            <div class="container">
                <h2 class="mb-lg">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ –ª–æ—Ç–µ—Ä–µ—è—Ö</h2>
                <div class="grid grid-4" id="stats-grid">
                    <div class="card stat-card loading">
                        <div class="stat-number">--</div>
                        <div class="stat-label">–õ–æ—Ç–µ—Ä–µ–π</div>
                    </div>
                    <div class="card stat-card loading">
                        <div class="stat-number">--</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                    </div>
                    <div class="card stat-card loading">
                        <div class="stat-number">--</div>
                        <div class="stat-label">–¢–∏—Ä–∞–∂–Ω—ã—Ö</div>
                    </div>
                    <div class="card stat-card loading">
                        <div class="stat-number">--</div>
                        <div class="stat-label">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommended Lotteries -->
        <section class="py-lg">
            <div class="container">
                <div class="flex-between mb-lg">
                    <h2>–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞–º –ª–æ—Ç–µ—Ä–µ–∏</h2>
                    <button class="btn btn-secondary" onclick="window.location.href='/lotteries'">
                        –í—Å–µ –ª–æ—Ç–µ—Ä–µ–∏ ‚Üí
                    </button>
                </div>

                <div id="recommendations-container" class="grid grid-3 loading">
                    <p style="grid-column: 1/-1; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</p>
                </div>
            </div>
        </section>

        <!-- Preferences Section -->
        <section class="py-lg" style="background: var(--color-bg-secondary);">
            <div class="container">
                <h2 class="mb-lg">–í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h2>
                <div class="card">
                    <div id="preferences-display" class="loading">
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                    <button class="btn btn-secondary mt-lg" onclick="showPreferencesModal()">
                        –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Preferences Modal -->
    <div id="preferences-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div class="card" style="max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
            <h2 class="mb-lg">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h2>
            <form id="preferences-form" onsubmit="updatePreferences(event)">
                <div class="form-group">
                    <label for="pref-budget">–ë—é–¥–∂–µ—Ç (‚ÇΩ)</label>
                    <input type="number" id="pref-budget" class="input" step="50">
                </div>
                <div class="form-group">
                    <label for="pref-type">–¢–∏–ø –≤—ã–∏–≥—Ä—ã—à–∞</label>
                    <select id="pref-type" class="input">
                        <option value="both">–õ—é–±–æ–π</option>
                        <option value="instant">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π</option>
                        <option value="draw">–¢–∏—Ä–∞–∂–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pref-size">–ñ–µ–ª–∞–µ–º–∞—è –≤–µ–ª–∏—á–∏–Ω–∞ –ø—Ä–∏–∑–∞</label>
                    <select id="pref-size" class="input">
                        <option value="small">–ù–µ–±–æ–ª—å—à–∏–µ —á–∞—Å—Ç—ã–µ –≤—ã–∏–≥—Ä—ã—à–∏</option>
                        <option value="medium">–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–∑—ã</option>
                        <option value="large">–ö—Ä—É–ø–Ω—ã–µ –ø—Ä–∏–∑—ã</option>
                        <option value="jackpot">–î–∂–µ–∫–ø–æ—Ç</option>
                    </select>
                </div>
                <div class="flex gap-md mt-lg">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="hidePreferencesModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/cursor-glow.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        requireAuth();

        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                // Update greeting with user's name
                const greeting = user.full_name
                    ? `–ü—Ä–∏–≤–µ—Ç, ${user.full_name}!`
                    : `–ü—Ä–∏–≤–µ—Ç!`;
                document.getElementById('user-greeting').textContent = greeting;

                // Display preferences
                if (user.preferences) {
                    displayPreferences(user.preferences);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadStatistics() {
            try {
                const data = await AnalyticsAPI.getSummary();
                const summary = data.summary;

                const statsCards = document.querySelectorAll('#stats-grid .stat-card');
                statsCards[0].innerHTML = `
                    <div class="stat-number">${summary.total_active_lotteries || 0}</div>
                    <div class="stat-label">–õ–æ—Ç–µ—Ä–µ–π</div>
                `;
                statsCards[1].innerHTML = `
                    <div class="stat-number">${summary.avg_ticket_price ? Math.round(summary.avg_ticket_price) + '‚ÇΩ' : 'N/A'}</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                `;
                statsCards[2].innerHTML = `
                    <div class="stat-number">${summary.draw_lotteries || 0}</div>
                    <div class="stat-label">–¢–∏—Ä–∞–∂–Ω—ã—Ö</div>
                `;
                statsCards[3].innerHTML = `
                    <div class="stat-number">${summary.instant_lotteries || 0}</div>
                    <div class="stat-label">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö</div>
                `;

                document.querySelectorAll('#stats-grid .stat-card').forEach(c => c.classList.remove('loading'));
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadRecommendations() {
            try {
                const data = await LotteriesAPI.getRecommended();
                const container = document.getElementById('recommendations-container');
                container.classList.remove('loading');

                if (data.recommendations && data.recommendations.length > 0) {
                    container.innerHTML = data.recommendations.slice(0, 6).map(rec => `
                        <div class="card">
                            <h3 class="mb-sm">${rec.lottery.name}</h3>
                            <div class="badge mb-md">–†–µ–π—Ç–∏–Ω–≥: ${rec.score.toFixed(0)}/100</div>
                            <p style="font-size: 0.9rem; color: var(--color-text-muted);">
                                ${rec.lottery.description || rec.explanation || '–ü–æ–¥—Ö–æ–¥—è—â–∞—è –¥–ª—è –≤–∞—Å –ª–æ—Ç–µ—Ä–µ—è'}
                            </p>
                            <p class="mt-sm" style="font-size: 1.1rem; font-weight: 600; color: var(--color-yellow-primary);">
                                ${rec.lottery.ticket_price}‚ÇΩ
                            </p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π</p>';
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendations-container').innerHTML =
                    '<p style="grid-column: 1/-1; text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>';
            }
        }

        function displayPreferences(prefs) {
            const typeMap = {
                'both': '–õ—é–±–æ–π',
                'instant': '–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π',
                'draw': '–¢–∏—Ä–∞–∂–Ω—ã–π'
            };
            const sizeMap = {
                'small': '–ù–µ–±–æ–ª—å—à–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏',
                'medium': '–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–∑—ã',
                'large': '–ö—Ä—É–ø–Ω—ã–µ –ø—Ä–∏–∑—ã',
                'jackpot': '–î–∂–µ–∫–ø–æ—Ç'
            };

            document.getElementById('preferences-display').innerHTML = `
                <div class="grid grid-2 gap-md">
                    <div>
                        <div style="color: var(--color-text-muted); font-size: 0.85rem;">–ë—é–¥–∂–µ—Ç</div>
                        <div style="font-size: 1.2rem; font-weight: 600;">${prefs.budget || '–ù–µ —É–∫–∞–∑–∞–Ω'}${prefs.budget ? '‚ÇΩ' : ''}</div>
                    </div>
                    <div>
                        <div style="color: var(--color-text-muted); font-size: 0.85rem;">–¢–∏–ø –≤—ã–∏–≥—Ä—ã—à–∞</div>
                        <div style="font-size: 1.2rem; font-weight: 600;">${typeMap[prefs.preferred_prize_type] || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div>
                        <div style="color: var(--color-text-muted); font-size: 0.85rem;">–ñ–µ–ª–∞–µ–º—ã–π –ø—Ä–∏–∑</div>
                        <div style="font-size: 1.2rem; font-weight: 600;">${sizeMap[prefs.preferred_prize_size] || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                </div>
            `;
        }

        function showPreferencesModal() {
            document.getElementById('preferences-modal').style.display = 'flex';
        }

        function hidePreferencesModal() {
            document.getElementById('preferences-modal').style.display = 'none';
        }

        async function updatePreferences(event) {
            event.preventDefault();

            const prefs = {
                budget: parseFloat(document.getElementById('pref-budget').value) || null,
                preferred_prize_type: document.getElementById('pref-type').value,
                preferred_prize_size: document.getElementById('pref-size').value
            };

            try {
                await PreferencesAPI.update(prefs);
                hidePreferencesModal();
                location.reload();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }

        function logout() {
            AuthAPI.logout();
        }

        // Load all data
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            loadStatistics();
            loadRecommendations();
        });
    </script>
</body>

</html>