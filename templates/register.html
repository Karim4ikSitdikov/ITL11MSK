<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Регистрация - Stoloto Assistant</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <main class="py-xl">
        <div class="container" style="max-width: 600px;">
            <div class="card">
                <h1 class="mb-md" style="text-align: center;">Регистрация</h1>

                <form id="register-form" onsubmit="handleRegister(event)">
                    <!-- Step 1: Email & Password -->
                    <div id="step-1">
                        <h3 class="mb-md">Шаг 1: Создайте аккаунт</h3>

                        <div class="form-group">
                            <label for="full-name">Ваше имя</label>
                            <input type="text" id="full-name" class="input" required
                                placeholder="Как к вам обращаться?">
                        </div>

                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" class="input" required placeholder="your@email.com">
                        </div>

                        <div class="form-group">
                            <label for="password">Пароль</label>
                            <input type="password" id="password" class="input" required placeholder="Минимум 6 символов"
                                minlength="6">
                        </div>

                        <div class="form-group">
                            <label for="confirm-password">Подтвердите пароль</label>
                            <input type="password" id="confirm-password" class="input" required
                                placeholder="Повторите пароль">
                        </div>

                        <button type="button" class="btn btn-primary" style="width: 100%;" onclick="nextStep()">
                            Далее: Укажите предпочтения
                        </button>
                    </div>

                    <!-- Step 2: Preferences -->
                    <div id="step-2" style="display: none;">
                        <h3 class="mb-md">Шаг 2: Ваши предпочтения</h3>
                        <p class="mb-lg" style="color: var(--color-text-muted);">
                            Эти данные помогут нам подобрать для вас наиболее подходящие лотереи
                        </p>

                        <div class="form-group">
                            <label for="budget">Бюджет для участия (₽)</label>
                            <input type="number" id="budget" class="input" placeholder="Например: 500" min="0"
                                step="50">
                        </div>

                        <div class="form-group">
                            <label for="prize-type">Тип выигрыша</label>
                            <select id="prize-type" class="input">
                                <option value="both">Любой</option>
                                <option value="instant">Мгновенный</option>
                                <option value="draw">Тиражный</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="prize-size">Желаемая величина приза</label>
                            <select id="prize-size" class="input">
                                <option value="small">Небольшие частые выигрыши</option>
                                <option value="medium">Средние призы</option>
                                <option value="large">Крупные призы</option>
                                <option value="jackpot">Джекпот</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="probability">Минимально приемлемая вероятность выигрыша</label>
                            <select id="probability" class="input">
                                <option value="0.0001">Любая (готов рискнуть)</option>
                                <option value="0.001">Низкая</option>
                                <option value="0.01">Средняя</option>
                                <option value="0.1">Высокая</option>
                            </select>
                        </div>

                        <div class="flex gap-md mt-lg">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">Назад</button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Зарегистрироваться</button>
                        </div>
                    </div>
                </form>

                <div id="register-error" style="color: #ff4444; margin-top: 1rem; display: none;"></div>
                <div id="register-loading" style="text-align: center; margin-top: 1rem; display: none;">
                    <div class="loading">Регистрация...</div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <p>Уже есть аккаунт? <a href="/" onclick="event.preventDefault(); window.history.back();">Войти</a>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/cursor-glow.js"></script>
    <script src="/static/js/api.js"></script>
    <script>
        let currentStep = 1;

        function nextStep() {
            // Validate step 1
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('register-error');

            if (!fullName || !email || !password) {
                errorDiv.textContent = 'Заполните все поля';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Пароли не совпадают';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Пароль должен быть не менее 6 символов';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            // Show step 2
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            currentStep = 2;
        }

        function prevStep() {
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            currentStep = 1;
        }

        async function handleRegister(event) {
            event.preventDefault();

            const errorDiv = document.getElementById('register-error');
            const loadingDiv = document.getElementById('register-loading');

            // Get form values
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const budget = parseFloat(document.getElementById('budget').value) || null;
            const prizeType = document.getElementById('prize-type').value;
            const prizeSize = document.getElementById('prize-size').value;
            const probability = parseFloat(document.getElementById('probability').value);

            const preferences = {
                budget,
                preferred_prize_type: prizeType,
                preferred_prize_size: prizeSize,
                min_acceptable_probability: probability,
                risk_profile: 'moderate'
            };

            try {
                errorDiv.style.display = 'none';
                loadingDiv.style.display = 'block';

                const data = await AuthAPI.register(email, password, preferences, fullName);
                setAuthToken(data.access_token);

                // Small delay to ensure token is saved to localStorage
                await new Promise(resolve => setTimeout(resolve, 100));

                // Redirect to dashboard
                window.location.href = '/dashboard';
            } catch (error) {
                errorDiv.textContent = error.message || 'Ошибка регистрации';
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        }

        // Check if already logged in
        if (isAuthenticated()) {
            window.location.href = '/dashboard';
        }
    </script>
</body>

</html>